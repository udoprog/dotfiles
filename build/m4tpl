#!/usr/bin/env perl

use strict;
use Cwd;

use feature 'say';

my $PROFILE_CONFIG = 'profile_config';
my $PROFILE_NAME = 'profile_id';

sub read_profile_name {
    return undef unless -f $PROFILE_NAME;
    open my $fp, '<', $PROFILE_NAME;
    my $value = <$fp>;
    close $fp;
    chomp $value;
    return $value;
}

sub main {
    die "Missing file: $PROFILE_CONFIG" unless -f $PROFILE_CONFIG;

    my $target = $ARGV[0];
    my $source = $ARGV[1];

    die "Missing source: $source" unless -f $source;

    my %config = do $PROFILE_CONFIG;
    my $profiles = $config{'profiles'};

    my $profile_name = read_profile_name;

    die "No profile configured: $PROFILE_NAME" unless $profile_name;

    my $profile = $config{ 'profiles' }->{ $profile_name };

    die "No such profile: $profile_name" unless $profile;

    my $cwd = getcwd;
    my @args = map { "-D$_=\"$profile->{$_}\"" } keys(%$profile);
    push @args, "-DPWD=$cwd";

    my $m4_args = join ' ', @args;

    say "Generating; $source -> $target";
    print "m4 $m4_args $source > $target\n";
    system "m4 $m4_args $source > $target";
    return 0;
}

exit main unless caller;
