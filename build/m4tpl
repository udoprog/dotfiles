#!/usr/bin/env python3

import os
import sys
import stat

try:
    import yaml
except ImportError:
    print('Could not import: yaml', file=sys.stderr)
    print('You might have to install it through:', file=sys.stderr)
    print('$ pip3 install --user pyyaml', file=sys.stderr)
    raise


secrets_template = {
  'template': True,
  'id': 'changeme',
  'secrets': {  }
}


def open_config(root):
    with open(os.path.join(root, 'config.yml')) as f:
        return yaml.load(f)


def open_secrets(root):
    p = os.path.join(root, 'secrets.yml')

    if not os.path.isfile(p):
        with open(p, 'w') as f:
            os.fchmod(f.fileno(), 0o400)
            yaml.dump(secrets_template, f)

        raise Exception(
            ('secrets does not exist, creating an empty one in ' +
             '{}').format(p))

    with open(p, 'r') as f:
        if (os.fstat(f.fileno()).st_mode & 0o777) != 0o400:
            raise Exception(
                ('secrets ({}) must have 0400 permission since it contains ' +
                 'sensitive data!').format(p))

        data = yaml.load(f)

    if 'template' in data:
        raise Exception(
            ('secrets is currently a template, modify it here and remove ' +
             '(template: true): {}').format(p))

    if 'id' not in data:
        raise Exception('secrets does not contain (id: myid)')

    return data


def load_variables(config, loc):
    p = config['profiles']

    if loc['id'] not in p:
        raise Exception('profile ({}) does not exist'.format(loc['id']))

    variables = dict(p[loc['id']])
    variables.update(dict((s, loc['secrets'][s]) for s in config['secrets']))

    return variables


def replace_all(variables, line):
    for key, value in variables.items():
        line = line.replace(key, value)

    return line


def main(args):
    root = os.path.dirname(os.path.dirname(sys.argv[0]))
    variables = load_variables(open_config(root), open_secrets(root))

    target = args[0]
    source = args[1]

    print('{} -> {}'.format(source, target))

    with open(source, 'r') as s:
        with open(target, 'w') as t:
            for line in s:
                  t.write(replace_all(variables, line))


if __name__ == "__main__":
    main(sys.argv[1:])
